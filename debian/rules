#!/usr/bin/make -f

composer:
	git config --global http.sslVerify false
	curl -sS http://getcomposer.org/installer | php -- --install-dir=. --filename=composer

build_doc:
	# Build doc using sphinx
	cd doc/sphinx ; sphinx-build -D"language=en" . ../html/en
	cd doc/sphinx ; sphinx-build -D"language=es" . ../html/es
	cd doc/sphinx ; sphinx-build -D"language=es" -bsinglehtml . ../html/essingle
	cd doc/sphinx ; sphinx-build -D"language=en" -bsinglehtml . ../html/ensingle

build_library: composer
	cd library ; ../composer --no-interaction --no-dev --prefer-dist install

build_webrest: composer build_library
	cd web/rest ; SYMFONY_ENV=prod ../../composer --no-interaction --no-dev --prefer-dist install

build_webadmin: composer build_library
	cd web/admin ; ../../composer --no-interaction --no-dev --prefer-dist install
	cd web/admin ; msgfmt -o application/languages/es_ES/es_ES.mo application/languages/es_ES/es_ES.po
	cd web/admin ; msgfmt -o application/languages/en_US/en_US.mo application/languages/en_US/en_US.po

build_webuser: build_webadmin
	cd web/user ; npm install bower grunt-cli karma grunt-karma
	cd web/user ; npm install
	cd web/user ; node_modules/bower/bin/bower install --allow-root
	cd web/user ; node_modules/grunt-cli/bin/grunt build
	cd web/user ; rm -f dist/.htaccess
	cd web/user ; mv dist/index.html ./index.phtml

build_scheme: composer
	cd scheme ; ../../composer --no-interaction --no-dev --prefer-dist install

override_dh_auto_build: build_doc build_webadmin build_webuser build_webrest build_scheme

override_dh_auto_install:
	dh_install
	# Remove .git directiories
	find debian -type d -name .git -exec rm -fr {} \;

# Install systemd unit files
override_dh_systemd_enable:
	dh_systemd_enable -p ivozprovider-asterisk-agi	  --name=fastagi@      fastagi@.service
	dh_systemd_enable -p ivozprovider-asterisk-agi	  --name=fastagi       fastagi.socket
	dh_systemd_enable -p ivozprovider-profile-proxy   --name=kamailio@     kamailio@.service --no-enable
	dh_systemd_enable -p ivozprovider-profile-data	  --name=cdrparser     cdrparser.service  --no-enable
	dh_systemd_enable -p ivozprovider-profile-portal  --name=gearman-job-server
	dh_systemd_enable -p ivozprovider-profile-portal  --name=ivozprovider-tarificator      --no-enable
	dh_systemd_enable -p ivozprovider-recordings      --name=ivozprovider-recordings          --no-enable

override_dh_systemd_start:
	dh_systemd_start  -p ivozprovider-asterisk-agi     --name=fastagi@     fastagi@.service   --no-restart-on-upgrade --no-start
	dh_systemd_start  -p ivozprovider-asterisk-agi     --name=fastagi      fastagi.socket     --no-restart-on-upgrade --no-start
	dh_systemd_start  -p ivozprovider-profile-proxy    --name=kamailio@    kamailio@.service  --no-restart-on-upgrade --no-start
	dh_systemd_start  -p ivozprovider-profile-data	   --name=cdrparser    cdrparser.service  --no-restart-on-upgrade --no-start
	dh_systemd_start  -p ivozprovider-profile-portal   --name=gearman-job-server              --no-restart-on-upgrade --no-start
	dh_systemd_start  -p ivozprovider-profile-portal   --name=ivozprovider-tarificator        --no-restart-on-upgrade --no-start
	dh_systemd_start  -p ivozprovider-recordings	   --name=ivozprovider-recordings         --no-restart-on-upgrade --no-start

# Install /etc/default configuration
override_dh_installinit:
	dh_installinit    -p ivozprovider-kamailio-users   --name=kamusers     --noscripts --no-restart-on-upgrade --no-start
	dh_installinit    -p ivozprovider-kamailio-trunks  --name=kamtrunks    --noscripts --no-restart-on-upgrade --no-start

%:
	dh $@ --with systemd
