;;
;; Incoming context for external calls.
;; ${EXTEN} must always match a configured DDI number
;;
[incoming]
exten => _X.,1,Syslog(Incoming call from ${CALLERID(all)} to ${EXTEN})
    same => n,Set(CALLERID(num)=${CUT(CUT(PJSIP_HEADER(read,P-Asserted-Identity),@,1),:,2)})
    same => n,Set(__CALL_ID=${PJSIP_HEADER(read,Call-id)})
;    same => n,Set(CONNECTED_LINE_SEND_SUB=update-line,${EXTEN},1)
    same => n,AGI(agi://127.0.0.1:4573/cli.php?model=default/calls/incoming)

;;
;; Outgoing context for terminals calls.
;; ${EXTEN} may match a Company Extension, Company Service or External number
;;
[outgoing]
exten => _[*0-9].,1,Syslog(Outgoing call from ${CALLERID(all)} to ${EXTEN})
    same => n,ExecIf($["${CHANNEL(channeltype)}" != "Local"]?Set(__CALL_ID=${PJSIP_HEADER(read,Call-id)}))
    same => n,AGI(agi://127.0.0.1:4573/cli.php?model=default/calls/outgoing)

;;
;; Context for calling a user (and handle User call forwards after the call)
;;
[call-user]
exten => _X.,1,Syslog(Calling from ${CALLERID(all)} to ${DIAL_DST})
    same => n,Dial(${DIAL_DST},${DIAL_TIMEOUT},${DIAL_OPTS}b(add-headers^${EXTEN}^1))
    same => n,AGI(agi://127.0.0.1:4573/cli.php?model=default/calls/userstatus)

;;
;; Context for Calling an external number through a trunk proxy
;;
[call-world]
exten => _X.,1,Syslog(Calling external number)
    same => n,Dial(${DIAL_DST},${DIAL_TIMEOUT},${DIAL_OPTS}b(add-headers^${EXTEN}^1))

;;
;; Context for Calling a user from an IVR (and handle IVR Noanswer call forwards)
;;
[call-ivr]
exten => _X.,1,Syslog(Calling from IVR to ${DIAL_DST})
    same => n,Dial(${DIAL_DST},${DIAL_TIMEOUT},gb(add-headers^${EXTEN}^1))
    same => n,AGI(agi://127.0.0.1:4573/cli.php?model=default/calls/ivrstatus)

;;
;; Context for Calling a user from a HuntGroup (and handle HuntGroup post-process or continues)
;;
[call-huntgroup]
exten => _X.,1,Syslog(Calling huntgroup)
    same => n,Dial(${DIAL_DST},${DIAL_TIMEOUT},gb(add-headers^${EXTEN}^1))
    same => n,AGI(agi://127.0.0.1:4573/cli.php?model=default/calls/hgstatus)

;;
;; Subroutine context for adding SIP headers on all outgoing channels
;;
[add-headers]
exten => _X.,1,Syslog(Adding Headers before placing call)
   same => n,AGI(agi://127.0.0.1:4573/cli.php?model=default/calls/addheaders)
   same => n,Return

;;
;; Subroutine context for updating presentation information on terminals
;;
[update-line]
exten => _X.,1,Syslog(Updating line information)
    same => n,AGI(agi://127.0.0.1:4573/cli.php?model=default/calls/updateLine)
    same => n,Return

;;
;; Subroutine context for handling 302 SIP redirections
;;
[update-redirecting]
exten => _X.,1,Syslog(Updating redirecting information)
    ;same => n,AGI(agi://127.0.0.1:4573/cli.php?model=default/calls/forward)
    same => n,Set(CONNECTEDLINE(num,i)=${REDIRECTING(to-num)})
    same => n,Return
